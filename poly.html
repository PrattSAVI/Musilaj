<!DOCTYPE html>
<html>

<head>

    <!-- Required meta tags -->
    <meta charset="utf-8">

    <!-- Bootstrap CSS -->
    <!-- Import BUnch of Things -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://cdn.rawgit.com/JDMcKinstry/JavaScriptDateFormat/master/Date.format.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css" />
    <script src="/path/to/src/jquery.csv.min.js"></script>

    <title>Marmara Müsilaj Haritasi</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            padding: 0;
            height: 50%;
            background-color: #212529;
        }
        
        p {
            color: #efefef
        }
        
        .container {
            width: 100%;
            height: 100%;
            margin: 0 0 0 0;
            max-width: 100%;
            max-height: 100%;
        }
        
        body {
            font-family: 'Raleway', sans-serif;
            font-weight: 500;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        #intro {
            padding: 15px 15px 15px 15px;
            font-size: 13px;
            max-height: 100vh;
            overflow: auto;
        }
        
        #kaynak {
            font-family: 'Raleway', sans-serif;
            font-weight: 300;
            font-size: 11px;
        }
        
        #title {
            color: #ffe000;
            font-family: 'Raleway', sans-serif;
            margin-top: 15px;
            font-weight: 700;
            font-size: 16px;
        }
        
        a {
            color: #ffe000;
        }
        
        img {
            margin-left: 0px;
            margin-right: 15px;
            width: 100%;
        }
        
        #controllers {
            margin: 5px 0px 15px 0px;
            padding: 15px 15px 15px 15px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        select {
            width: 100%;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="row">
            <div class="col-4">

                <div id="intro">


                    <p id="title"><b>MARMARA MÜSİLAJ HARİTASI</b></p>

                    <!-- Control ve dropdown -->
                    <div id='controllers'>
                        <p>Goruntuleme yapmak istediginiz tarihi secin</p>
                        <form>
                            <select name="dropdown" id='date-selector'>
                            </select>
                        </form>
                    </div>


                    <p>
                        Yandaki interaktif harita, son günlerin sıkça tartışılan konularından biri olan Marmara Denizi'ndeki deniz müsilajının güncel yayılımını göstermektedir.
                        <br><br> Müsilaj oluşumu, Akdeniz'de ilk defa 1729 yılında belgelenmiş, özellikle geçtiğimiz 30 yılda artan sıklıklarda gözlenmeye devam etmiştir <sup>[1]</sup>. Marmara Denizi'nde ise en belirgin müsilaj oluşumu 2007 yılında görülmüştür.
                        2007'deki deniz salyası birikimi, İzmit Körfezi'nden Çanakkale Boğazı'na kadar yayılmış, ve bugünküne benzer bir şekilde, daha ağır sanayiden etkilenen ve akıntının Marmara Denizi'ne göre daha yavaş olduğu Körfez'de daha uzun süre
                        ve yoğun bir şekilde kalmıştır <sup>[2]</sup>.
                        <br><br>Yine de, bu sene gözlenen vakanın öncekilere göre daha yoğun olduğu aşikar. Çeşitli kaynaklara göre bu da beklendik bir durum, ve birkaç parametrenin birleşimi.
                        <br><br>Herşeyden önce küresel ısınmanın müsilaj yoğunluğu ve yayılımı ile doğrudan etkisi var: Danovaro ve diğerlerinin 2009 yılında yayınlanan çalışması <sup>[3]</sup>, inceleme yaptıkları 60 yıl boyunca Akdeniz'de görülen iklim
                        anomalileri ile müsilaj patlamalarının doğrudan eşleştiğini gösteriyor. MGM'nin resmi istatistiklerine bakıldığında <sup>[4]</sup> Marmara Denizi'nin 1970-2020 yılları arasında 2°C'den fazla ısındığı görülüyor.
                        <br><br>İkincisi parametre ise tabi ki atık yönetimi. Onyıllardır Marmara Denizi çevresindeki yerleşim alanları, denizi derin deşarj alanı olarak kullanıyor. Haritada nokta olarak yerlerini gördükleriniz, İstanbul'daki atık su
                        deşarj alanları. Bu noktalar dışında denetimsiz deşarjların yapılıyor olduğu ve İstanbul dışındaki şehirlerin deşarj noktalarının bu haritada yer almadığı gerçeğini unutmamak gerek.
                        <br><br>Yeterli oranda arıtılmadan denize boşaltılan atık su, her ne kadar derinden deşarj edilse de, yılların birikimi ile bu atığın etkisi yüzeyde de kendini göstermeye başlıyor. Marmara Denizi'nin dip akıntısı kuzeye, Karadeniz'e
                        doğru. Fakat yüzey akıntısı ters yönde: aşağıdaki gördüğünüz oklar, yüzey akıntısının basitleştirilmiş bir şeması <sup>[5]</sup>. Bu yüzey akıntısı deseni ve bilinen deşarj noktaları birlikte düşünüldüğünde, mevcut müsilaj dağılımı
                        anlamlı hale geliyor, ve yakın gelecekte ne şekilde yayılmaya devam edeceğine dair ip uçları veriyor.
                    </p>

                    <img src="https://raw.githubusercontent.com/PrattSAVI/Musilaj/main/BogazAkinti_Koyu.jpg"></img>
                    <p>
                        <br><br>Bu çalışma, bir süredir çeşitli uzmanın yaptıkları açıklamaları harita üzerinde görselleştirmek amacıyla hazırlandı. Eğer veride veya metinde herhangi bir hata olduğunu düşünüyorsanız bize info@bitsnbricks.com adresinden
                        ulaşabilir, eklemek istediklerinizi <a href="https://twitter.com/search?q=%23musilajharitasi&src=typed_query">#musilajharitasi</a> ile twitter'dan paylaşabilirsiniz!
                        <br><br> Müsilaj verisi Sentinel-2 uydusunun 23 Mayıs ile 8 Haziran tarihleri arasında okumları birleştirilerek elde edilmiştir. Uydu görüntülerinin 4,8a ve 11 bantları kompozitleştirilerek, gözetimli bir makina öğrenmesi algoritması
                        ile eğitilmiş ve tüm Marmara'ya uygulanmıştır. Veriyi vektör formatında <a href="https://github.com/PrattSAVI/Musilaj">buradan</a> indirebilirsiniz. Sentinel-2 verisine ve makine öğrenme algoritmasının eğitim setine
                        <a href="https://github.com/PrattSAVI/Musilaj">buradan</a> ulaşabilirsiniz.
                    </p>

                    <p id="kaynak">
                        <br>[1] Vollenweider, R. A., Montanari, G., Rinaldi, A. (1995) Statistical inferences about the mucilage events in the Adriatic Sea, with special reference to recurrence patterns and claimed relationship to sun activity cycles,
                        Science of The Total Environment, 165 (1–3). 1995, s. 213-224, ISSN 0048-9697. doi:10.1016/0048-9697(95)04554-E.
                        <br>[2] Aktan Y, Dede A, Ciftci P S. 2008. Mucilage event associated with diatoms and dinoflagellates in Sea of Marmara, Turkey. Harmful Algae News, 36.
                        <br>[3] Danovaro R, Fonda Umani S, Pusceddu A. (2009) Climate change and the potential spreading of marine mucilage and microbial pathogens in the Mediterranean Sea. PLoS One. 2009 Sep 16;4(9):e7006. doi: 10.1371/journal.pone.0007006.
                        PMID: 19759910; PMCID: PMC2739426.
                        <br>[4] T.C. Tarım ve Orman Bakanlığı, Meteoroloji Genel Müdürlüğü. Resmi İstatistikler, <a href="https://www.mgm.gov.tr/FILES/resmi-istatistikler/denizSuyu/Marmara-Deniz-Suyu-Sicakligi-Analizi-2019.pdf">Deniz Suyu Sıcaklıkları.</a>                        (09.06.2021 tarihinde erişilmiştir).
                        <br>[5] Beşiktepe, Ş. T., Sur, H. İ., Özsoy, E., Latif, M. A., Oǧuz, T., Ünlüata, Ü. (1994) The circulation and hydrography of the Marmara Sea, Progress in Oceanography, 34 (4). 1994. s. 285-334. ISSN 0079-6611, doi:10.1016/0079-6611(94)90018-3.
                    </p>

                    <p>
                        <i>by <a href="http://bitsnbricks.com/">Bits 'n Bricks</a> & <a href="https://commons.pratt.edu/savi/">SAVI</a> & TUM <a href="https://www.ar.tum.de/en/klima/start/">Chair of Building Technology and Climate-Responsive Design</a></i>
                    </p>

                </div>
            </div>
            <div class="col-8">
                <div id="map"></div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    // ---  LEAFLET Basemap Tiles
    //40.70197835318973, 28.28485189674848
    var map = L.map('map').setView([40.7019, 28.2848], 9);

    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/" style="color:#ffe000">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright"  style="color:#ffe000">OpenStreetMap</a> <strong><a  style="color:#ffe000" href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>',
        tileSize: 512,
        maxZoom: 14,
        minZoom: 8,
        zoomOffset: -1,
        id: 'mapbox/dark-v10',
        accessToken: 'pk.eyJ1IjoiY2Fua2FkaXIiLCJhIjoiY2pteXplNnEzMHF3YTNrcGx0dGd4MmJrdiJ9.zbhQ39YIdfZufTljuTSl1w'
    }).addTo(map);


    // Style Object for the general Polygon Styline
    function style(data) {
        return {
            fillColor: '#ffe000', // Here is the categorical coloring.
            color: '#ffffff',
            weight: 0.15,
            opacity: 1,
            fillOpacity: 0.7
        };
    }

    // Polygons
    function generatePolygon(data, date, L) {

        $(".leaflet-interactive").remove();

        //let filtered = jQuery.extend(true, {}, data);
        let filtered = data.features.filter(function(f) {
            return f.properties.date == date;
        });

        let geoJsonLayer = L.geoJSON(filtered, {
            style: style,
            //onEachFeature: onEachFeature
        }).addTo(map);

        return geoJsonLayer;

    }

    // Points
    function generatePts(data, L) {

        var geojsonMarkerOptions = {
            radius: 2.5,
            fillColor: "#ffffff",
            //color: "#000",
            weight: 0,
            opacity: 1,
            fillOpacity: 0.8
        };

        geoJsonPoints = L.geoJSON(data, {
            pointToLayer: function(feature, latlng) {
                return L.circleMarker(latlng, geojsonMarkerOptions);
            }
        }).addTo(map);

        return geoJsonPoints;

    }

    let path = 'https://raw.githubusercontent.com/PrattSAVI/Musilaj/main/Data/20210617_data_all.geojson'
    let noktalar = 'https://raw.githubusercontent.com/PrattSAVI/Musilaj/main/Data/Desarj_points.geojson'
    let twit_path = 'https://raw.githubusercontent.com/PrattSAVI/Musilaj/main/Data/tw/Tweets.json';

    // ------------------- WORK WITH DATA STARTS HERE--------------------------

    // Polygons
    $.getJSON(path, function(data) { // Polygons

        //// Desarj Noktalari Add as Geojson Layer
        $.getJSON(noktalar, function(pts) {
            generatePts(pts, L);
        });

        // -----------------  Data Here  ----------------------

        // Get Unique Dates in the data set, GeoJSON
        // Insert unique days to dropdown.
        const uniques = new Set();
        data.features.forEach((item) => {
            uniques.add(item.properties.date);
        });
        let unique_dates = Array.from(uniques); // Make array

        //Insert into dropdown
        unique_dates.forEach(function(d, i) {
            const date = new Date(d);
            longd = date.format('d/m/y');
            $('#date-selector').append(`<option value="${d}">${longd}</option>`);
            $("#date-selector").prop("selectedIndex", 0); // Select first
        });



        //Create Initial  polygon
        geoJsonLayer = generatePolygon(data, unique_dates[0], L);

        // Zoom Based Styling
        map.on('zoomend', function() {

            let zl = map.getZoom();

            if (zl <= 10) {
                geoJsonLayer.setStyle({
                    weight: 0.15
                })
            } else if (zl => 13) {
                geoJsonLayer.setStyle({
                    weight: 1
                })
            } else if (zl === 8) {
                geoJsonLayer.setStyle({
                    weight: 0.05
                })
            } else {
                geoJsonLayer.setStyle({
                    weight: 0.4
                })
            }

        });

        // Create the filter -> Filter data based on dropdown.
        $('#date-selector').change(function() {
            let selected_date = $(this).val();
            geoJsonLayer = generatePolygon(data, selected_date, L);
        });

    });

    // Twitter starts here
    $.getJSON(twit_path, function(twit) {

        console.log(twit)
    })
</script>